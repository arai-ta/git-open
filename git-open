#!/bin/bash
#
# @(#) Tiny script that opens github repository in the browser.
#      https://github.com/arai-ta/git-open

set -e
set -u
#set -x

if ! git show >/dev/null
then
    exit 1
fi

DO_COPY=
USE_HASH=
while getopts ph OPT
do
    case $OPT in
        p)  DO_COPY=1
            shift ;;
        h)  USE_HASH=1
            shift ;;
        *) cat <<USAGE
Usage: git open [-p] [-h] [path/to/file]
USAGE
            exit ;;
    esac
done

url=$(git remote -v | \
    awk '
        $3 ~ /fetch/{
            url=$2;
            if (url !~ /^https?:/) {
                sub(/:/, "/", url);
                sub(/git@/, "https://", url);
                sub(/\.git$/, "", url);
            }
            print url
        }')

if [ -z "$url" ]
then
    echo "No remote found."
    exit 2
fi

if [ "${1:-}" -a -e "${1:-}" ]
then
    path=$1
    if [ $USE_HASH ]
    then
        # hash
        treeish=$(git log -1 --format=%H)
    else
        # branch
        treeish=$(git branch | \
            awk '
                /^\*/{
                    print $2
                }')
    fi
    url=$url/blob/$treeish/$path
fi

echo $url
if [ $DO_COPY ]
then
    echo $url | pbcopy
    echo "Copy url to clipboard!" >&2
else
    open $url
fi
